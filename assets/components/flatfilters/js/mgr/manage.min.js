import*as functions from"./functions.min.js";export default class manage{constructor(e){this.config=Object.assign({storageKey:"flatfilters",methodSelector:"[data-js-method]",wrapperSelector:'[data-js-wrapper="${name}"]',targetSelector:"[data-js-target]",eventSelector:"[data-js-event]",valueSelector:"[data-js-value]",selectedSelector:'[data-js-selected="${name}"]',suggestionWrapSelector:'[data-js-suggestions="${name}"]',selectedKey:"jsSelected",methodKey:"jsMethod",wrapperKey:"jsWrapper",actionKey:"jsAction",fieldsKey:"jsFields",sortKey:"jsSort",classKey:"jsClass",dirKey:"jsDir",valueKey:"jsValue",captionKey:"jsCaption",targetKey:"jsTarget",tplKey:"jsTpl",allowKey:"jsAllow",eventKey:"jsEvent",valueAttribute:"data-js-value"},e),this.mainContainer=document.querySelector("#modx-content"),this.mainContainer.innerHTML=this.config.template,this.config.headers={"X-Requested-With":"XMLHttpRequest",modAuth:MODx.siteId},this.initialize(),console.log(this.config)}initialize(){if(sessionStorage.removeItem(this.config.storageKey),this.config.storage)for(var e in this.config.storage)this.config.storage[e]&&this.setStorageValue(e,this.config.storage[e]);const t=document.querySelectorAll(this.config.eventSelector),s=[];t.forEach(e=>{e=e.dataset[this.config.eventKey];s.includes(e)||s.push(e)}),s.length&&s.forEach(e=>document.addEventListener(e,this.callMethod.bind(this))),document.addEventListener("click",e=>{var t=this.config.selectedSelector.replace('="${name}"',"");if(!e.target.closest(t)){const s=document.querySelectorAll(this.config.methodSelector);s&&s.forEach(e=>this.getSuggestionsWrap(e))}e.target.closest(this.config.valueSelector)&&(t=e.target.closest(t))&&this.removeSelected(e,t.dataset[this.config.selectedKey],e.target.dataset[this.config.valueKey])})}callMethod(e){var t=e.target.closest(this.config.methodSelector);t&&e.type===t.dataset[this.config.eventKey]&&(e.preventDefault(),void 0!==this[e=t.dataset[this.config.methodKey]]&&this[e](t))}sendForm(e){const t=new FormData(e);var s,a=this.getValueFromStorage();for(s in a){let e=a[s];"object"==typeof a[s]&&(e=JSON.stringify(a[s])),t.has(s)?t.set(s,e):t.append(s,e)}functions.sendAjax(t,(e,t)=>this.responseHandler(e,t),this.config.connector_url,this.config.headers,{target:e})}responseHandler(e,t){console.log(e),e.success&&("mgr/configuration/create"===e.object.action&&e.object.id&&(t.target.id.value=e.object.id,t.target.action.value="mgr/discount/update",window.location.replace(window.location.href+"&id="+e.object.id)),functions.showNotify(e.message))}clearAll(e){var e=e.dataset[this.config.targetKey],t=this.config.selectedSelector.replace("${name}",e),s=this.config.wrapperSelector.replace("${name}",e);const a=document.querySelector(t)||document.querySelector(s);this.removeStorageValue(e),a&&(a.innerHTML=""),"filters"===e&&(document.getElementById("submitBtn").disabled=!0)}removeItem(e){const t=document.getElementById(e.dataset[this.config.targetKey]);t&&t.remove();let s=this.getStorageValue(t.dataset[this.config.valueKey])?this.getStorageValue(t.dataset[this.config.valueKey]):{};delete s[e.dataset[this.config.valueKey]],this.setStorageValue(t.dataset[this.config.valueKey],s),document.getElementById("submitBtn").disabled=!Object.keys(s).length}setAllowed(e){const a=document.getElementById(e.dataset[this.config.targetKey]),i=e.options[e.selectedIndex].dataset[this.config.allowKey].split(",");delete a.options.length,Array.from(a.options).map((e,t,s)=>{0===t&&(a.selectedIndex=-1),e.disabled=!i.includes(e.value),e.selected=!e.disabled&&-1===a.selectedIndex,e.selected&&(a.selectedIndex=t)})}removeSelected(e,t,s){let a=this.getStorageValue(t)?this.getStorageValue(t).split(","):[];a=a.filter(e=>Number(e)!==Number(s)),this.setStorageValue(t,a.join(",")),e.target.remove()}getLocalSuggestions(t){var e;2<t.value.length?(e=this.config.filters_keys.filter(e=>-1!==e.key.indexOf(t.value)||-1!==e.caption.indexOf(t.value)),console.log(),this.manageSuggestions(e,{el:t})):this.manageSuggestions([],{el:t})}getSuggestions(e){if(2<e.value.length){const t=new FormData;t.append("action",e.dataset[this.config.actionKey]),t.append("fields",e.dataset[this.config.fieldsKey]),t.append("sort",e.dataset[this.config.sortKey]),t.append("class",e.dataset[this.config.classKey]),t.append("value",e.value),functions.sendAjax(t,(e,t)=>this.manageSuggestions(e.results,t),this.config.connector_url,this.config.headers,{el:e})}else this.manageSuggestions([],{el:e})}manageSuggestions(e,s){const a=this.getSuggestionsWrap(s.el);a&&e.length&&(e.forEach(e=>{var t=e.key||e.id,e=e[s.el.dataset[this.config.captionKey]],t=this.createElement("li",t,e,{click:e=>this.suggestionSelect(e,s.el,a)});a.appendChild(t)}),a.classList.remove("d-none")),a&&!e.length&&a.classList.add("d-none")}getSuggestionsWrap(e){e=this.config.suggestionWrapSelector.replace("${name}",e.id);const t=document.querySelector(e);return t&&(t.innerHTML=""),t&&t.classList.add("d-none"),t}createElement(e,t,s,a){const i=document.createElement(e);for(var o in i.setAttribute(this.config.valueAttribute,t),i.innerText=s,a)i.addEventListener(o,a[o]);return i}setFilters(t){var e=t.closest("form");const s=new FormData;var a=e[t.dataset[this.config.targetKey]],i=this.config.wrapperSelector.replace("${name}",a.id),i=document.querySelector(i);const o={};if(e&&Array.from(e).forEach(e=>{e.value&&e.name&&(o[e.name]=e.dataset[this.config.valueKey]||e.value)}),Object.keys(o).length&&a.dataset[this.config.valueKey]){let e=this.getStorageValue(a.id)?this.getStorageValue(a.id):{};if(!e.hasOwnProperty(a.dataset[this.config.valueKey])){for(var n in e[a.dataset[this.config.valueKey]]=o,this.setStorageValue(a.id,e),o)s.append(n,o[n]);s.append("action",t.dataset[this.config.actionKey]),s.append("tpl",t.dataset[this.config.tplKey]),functions.sendAjax(s,(e,t)=>this.insertHTML(e,t),this.config.connector_url,this.config.headers,{wrapper:i}),document.getElementById("submitBtn").disabled=!1}}}insertHTML(e,t){const s=new DOMParser;var a=s.parseFromString(e.object.html,"text/html");t.wrapper&&e.object&&e.object.html&&t.wrapper.appendChild(a.body.firstChild)}suggestionSelect(t,s,e){var a=this.config.selectedSelector.replace("${name}",s.id);const i=document.querySelector(a);if(-1===s.id.indexOf("filters")){let e=this.getStorageValue(s.id)?this.getStorageValue(s.id).split(","):[];e.includes(t.target.dataset[this.config.valueKey])||(e.push(t.target.dataset[this.config.valueKey]),this.setStorageValue(s.id,e.join(",")))}i?(s.value="",a=this.createElement("span",t.target.dataset[this.config.valueKey],t.target.innerText,{}),i.appendChild(a)):(s.dataset[this.config.valueKey]=t.target.dataset[this.config.valueKey],s.value=t.target.innerText),e.innerHTML="",e.classList.add("d-none")}setStorageValue(e,t){const s=this.getValueFromStorage();s[e]=t,sessionStorage.setItem(this.config.storageKey,JSON.stringify(s))}getStorageValue(e){return this.getValueFromStorage()[e]}removeStorageValue(e){const t=this.getValueFromStorage();delete t[e],sessionStorage.setItem(this.config.storageKey,JSON.stringify(t))}getValueFromStorage(){return sessionStorage.getItem(this.config.storageKey)?JSON.parse(sessionStorage.getItem(this.config.storageKey)):{}}}