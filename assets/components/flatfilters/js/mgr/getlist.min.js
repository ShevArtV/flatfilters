import*as functions from"./functions.min.js";export default class GetList{constructor(e){this.config=e,this.mainContainer=document.querySelector("#modx-content"),this.mainContainer.innerHTML=this.config.template,this.config.rows_wrapper=document.querySelector("#rows"),this.config.row_prefix="#item-",this.config.remove_modal=document.querySelector("#removeModal"),this.config.copy_modal=document.querySelector("#copyModal"),this.config.modals=document.querySelectorAll(".modal"),this.config.forms=document.querySelectorAll("[data-js-form]"),this.config.activateForms=document.querySelectorAll(".js_form_active"),this.start=0,this.limit=document.querySelector('input[name="limit"]'),this.current_page=document.querySelector('input[name="current_page"]'),this.first_on_page_el=document.querySelector("#first_on_page"),this.last_on_page_el=document.querySelector("#last_on_page"),this.page_total_el=document.querySelector("#page_total"),this.total_el=document.querySelector("#total"),this.to_first_btn=document.querySelector(".js-to-first"),this.to_prev_btn=document.querySelector(".js-to-prev"),this.to_last_btn=document.querySelector(".js-to-last"),this.to_next_btn=document.querySelector(".js-to-next"),this.changeEvent=new Event("change"),this.config.headers={"X-Requested-With":"XMLHttpRequest",modAuth:MODx.siteId},this.initialize()}initialize(){this.config.activateForms.length&&this.config.activateForms.forEach(e=>{this.addListenerToActiveBtn(e)}),this.config.remove_modal&&this.addListenerToRemoveForm(this.config.remove_modal),this.config.copy_modal&&this.config.copy_modal.addEventListener("shown.bs.modal",function(e){functions.confirmModal(this.config.copy_modal,{id:e.relatedTarget.dataset.id})}.bind(this)),this.current_page&&this.current_page.addEventListener("change",e=>{let t,i=Number(this.page_total_el.innerText),s=Number(this.current_page.value);t=((s=(s=s>i?i:s)<1?1:s)-1)*this.limit.value,this.current_page.value=s,this.getList(t,this.limit.value)}),this.limit&&this.limit.addEventListener("change",e=>{this.current_page.value=1,this.current_page.dispatchEvent(this.changeEvent)}),this.to_first_btn&&this.to_first_btn.addEventListener("click",e=>{this.current_page.value=1,this.current_page.dispatchEvent(this.changeEvent)}),this.to_prev_btn&&this.to_prev_btn.addEventListener("click",e=>{this.current_page.value=Number(this.current_page.value)-1,this.current_page.dispatchEvent(this.changeEvent)}),this.to_next_btn&&this.to_next_btn.addEventListener("click",e=>{this.current_page.value=Number(this.current_page.value)+1,this.current_page.dispatchEvent(this.changeEvent)}),this.to_last_btn&&this.to_last_btn.addEventListener("click",e=>{this.current_page.value=this.page_total_el.innerText,this.current_page.dispatchEvent(this.changeEvent)}),this.config.forms.length&&this.setFormHandler(this.config.forms)}setFormHandler(e){e.forEach(i=>{let e=i.querySelectorAll("[name]");i.addEventListener("submit",e=>{e.preventDefault(),i.closest(".btn-group").classList.add("disabled");e=new FormData(i);this.sendForm(e,i)}),e.forEach(t=>{t.addEventListener("input",e=>{t.classList.contains("error")&&this.hideErrors(t,i)})})})}sendForm(e,t){functions.sendAjax(e,e=>{e.success?this.responseSuccess(e,t):(this.showErrors(e.data,t),e.message&&functions.showNotify(e.message,"error"))},this.config.connector_url,this.config.headers)}responseSuccess(e,t){var i;"mgr/configuration/duplicate"===e.object.action&&e.object.url&&(window.location.href=e.object.url),"mgr/configuration/indexing"===e.object.action&&(document.querySelector(`#item-${e.object.id} .progress`).classList.remove("progress_finished"),e.object.finished?(document.querySelector(`#item-${e.object.id} .progress`).style.width=e.object.percent,document.querySelector(`#item-${e.object.id} .progress`).classList.add("progress_finished"),t.closest(".btn-group").classList.remove("disabled")):(i=new FormData(t),this.sendForm(i,t),document.querySelector(`#item-${e.object.id} .progress`).style.width=e.object.percent))}hideErrors(e,t){let i=t.querySelector(".error_"+e.name);e.classList.remove("error"),i&&(i.innerText="")}showErrors(e,t){e.forEach(e=>{t.querySelector(".error_"+e.id)&&(t.querySelector(".error_"+e.id).innerText=e.msg),t.querySelector('[name="'+e.id+'"]')&&t.querySelector('[name="'+e.id+'"]').classList.add("error")})}pagination(e){let t=Math.ceil(e/this.limit.value),i=(Number(this.current_page.value)-1)*Number(this.limit.value)+1,s=i+Number(this.limit.value)-1;this.page_total_el&&(this.page_total_el.innerText=t),this.first_on_page_el&&(this.first_on_page_el.innerText=i),this.last_on_page_el&&(s>Number(this.total_el.innerText)&&(s=Number(this.total_el.innerText)),this.last_on_page_el.innerText=s),this.total_el&&(this.total_el.innerText=e),this.page_total_el&&this.current_page.value&&(1==this.current_page.value?(this.to_first_btn.disabled=!0,this.to_prev_btn.disabled=!0):(this.to_first_btn.disabled=!1,this.to_prev_btn.disabled=!1),this.current_page.value==this.page_total_el.innerText?(this.to_last_btn.disabled=!0,this.to_next_btn.disabled=!0):(this.to_last_btn.disabled=!1,this.to_next_btn.disabled=!1))}getList(e,t){let i=new FormData;i.append("start",e),i.append("limit",t),i.append("action","mgr/discount/getlist"),functions.sendAjax(i,e=>{if(this.config.rows_wrapper.classList.remove("loading"),e.success&&e.total){this.renderResult(e.results);const t=document.querySelectorAll(".js_form_active");t.length&&t.forEach(e=>{this.addListenerToActiveBtn(e)}),this.pagination(e.total),this.config.remove_modal&&this.addListenerToRemoveForm(this.config.remove_modal)}},this.config.connector_url,this.config.headers,this.config.rows_wrapper)}addListenerToRemoveForm(t){let i=t.querySelector("form");this.config.remove_modal.addEventListener("shown.bs.modal",function(e){functions.confirmModal(t,{id:e.relatedTarget.dataset.id})}),i.addEventListener("submit",e=>{e.preventDefault();e=new FormData(i);functions.sendAjax(e,e=>{e.success&&functions.success(e,this.config.rows_wrapper,this.config.modals,this.config.row_prefix)},this.config.connector_url,this.config.headers,this.config.rows_wrapper)})}addListenerToActiveBtn(r){r.addEventListener("submit",e=>{e.preventDefault();let t=document.querySelector('button[form="'+r.getAttribute("id")+'"]'),i=r.querySelector('[name="active"]'),s;t.classList.contains("choosen")?i.value=0:i.value=1,t.disabled=!0,s=new FormData(r),functions.sendAjax(s,e=>{this.config.rows_wrapper.classList.remove("loading"),e.success&&(t.classList.toggle("choosen"),t.disabled=!1)},this.config.connector_url,this.config.headers,this.config.rows_wrapper)})}renderResult(e){let t="";e.forEach(e=>{t+=e.html}),this.config.rows_wrapper.innerHTML=t}}